# BM

![birch](./assets/birch-296x328.png)

Simple Virtual Machine with its own Bytecode and Assembly language.

## Build

We are using [nobuild](https://github.com/tsoding/nobuild) build system which requires a bootstrapping step with any relatively standard complaint C compiler.

On Linux/MacOS/FreeBSD/literally any OS on the planet Earth except Windows with MSVC:

```console
$ cc -o nobuild nobuild.c
$ ./nobuild help
```

If you still want to use MSVC on Windows run [vcvarsall.bat](https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-160) and from within the development environment of MSVC:

```console
> cl.exe nobuild.c
> nobuild.exe help
```

The `nobuild` executable expects subcommands as the command line arguments, which you can provide several of at the same time like this `$ ./nobuild build examples test`. This will first [build the toolchain](#building-the-toolchain), then [build the examples](#building-and-running-examples), and then [run the tests](running-and-recoding-tests) against examples.

### Building the Toolchain

This builds the [toolchain][#toolchain] of the Virtual Machine:

```console
$ ./nobuild build
```

The binaries of the toolchain will be placed in `./build/bin/`.

### Building and Running Examples

To build the examples you need to [build the toolchain](#building-the-toolchain) first:

```console
$ ./nobuild build examples
```

The examples will be placed in `./build/examples/`.

To run the examples use [basm](#basm) executable from the [toolchain](#toolchain):

```
$ ./build/bin/bme -i ./build/examples/hello.bm
$ ./build/bin/bme -i ./build/examples/fib.bm
$ ./build/bin/bme -i ./build/examples/e.bm
$ ./build/bin/bme -i ./build/examples/pi.bm
```

#### Adding More Examples

`nobuild examples` automatically builds all the `./examples/*.basm` files. So if you want to add a new example to the build just add `*.basm` file to [./examples/](./examples/).

### Running and Recoding Tests

<!-- TODO: Running and Recoding Tests is not documented -->
TBD

## Toolchain

### basm

Assembly language for the Virtual Machine. For examples see [./examples/](./examples) folder.

### bme

BM emulator. Used to run programs generated by [basm](#basm).

### bdb

BM debuger. Used to step debug programs generated by [basm](#basm).

### debasm

Disassembler for the binary files generated by [basm](#basm)

### bmr

BM recorder. Used to record the output of binary files generated by [basm](#basm) and comparing those output to the expected ones. We use this tool for Integration Testing.

### basm2nasm

An experimental tool that translates BM files generated by [basm](#basm) to an assembly files in [NASM](https://www.nasm.us/) dialect for x86_64 Linux.

### expr2dot

Accepts [BASM translation-time expression](./docs/assembly.md#translation-time-expressions) as a command line argument and dumps its AST in [dot format](https://graphviz.org/doc/info/lang.html) that you can render later with [graphviz](https://graphviz.org/download/) later.

```console
$ ./expr2dot "f(a) + g(b) + 69 > 420" | dot -Tsvg > ast.svg
$ iexplore.exe ast.svg
```

## Editor Support

### Emacs

Emacs mode available in [./tools/basm-mode.el](./tools/basm-mode.el). Until the language stabilized and we upload the mode on [MELPA](https://melpa.org/) you need to install this mode manually.

Add the following lines to your `.emacs` file:

```emacs-lisp
(add-to-list 'load-path "/path/to/basm-mode/")
(require 'basm-mode)
```

### Vim

Copy [./tools/basm.vim](./tools/basm.vim) in `.vim/syntax/basm.vim`. Add the following line to your `.vimrc` file:

```vimscript
autocmd BufRead,BufNewFile *.basm set filetype=basm
```
